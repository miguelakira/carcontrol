%p
  %b= link_to 'GERAR DOCUMENTO PDF', :action => 'generate_pdf', :id => @cegonha.id

.row{ 'data-equalizer' => ""}
  %div{:class => @grid}
    %table.text-left{ :cellspacing => "0", :summary => "Detalhes da Cegonha", :width => '450px', 'data-equalizer-watch' => '' }
      %caption
        %h5
          Detalhes da Cegonha
      %tr
        %th
          Placa da Cegonha
        %td
          = @cegonha.placa 
      - if @cegonha.empresa
        %tr
          %th 
            Pertencente à Empresa
          %td
            = @cegonha.empresa.nome
      %tr
        %th 
          Carros na Cegonha
        %td
          = raw(carros_na_cegonha(@cegonha)).html_safe
      %tr
        %th 
          Localização Atual
        %td
          = @cegonha.localizacao
      - unless @cegonha.cidade_origem.nil? or @cegonha.estado_origem.nil?
        %tr
          %th 
            Origem
          %td
            = Cidade.find(@cegonha.cidade_origem).text
            = Estado.find(@cegonha.estado_origem).sigla
      
      - unless @cegonha.cidade_destino.nil? or @cegonha.estado_destino.nil?
        %tr
          %th 
            Destino
          %td
            = Cidade.find(@cegonha.cidade_destino).text
            = Estado.find(@cegonha.estado_destino).sigla
      %tr
        %th
          Observação
        %td
          = @cegonha.observacao

  %div{:class => @grid}
    %table.text-left{ :cellspacing => "0", :summary => "Detalhes do Motorista", :width => '450px', 'data-equalizer-watch' => '' }
      %caption
        %h5
          Detalhes do Motorista
      %tr
        %th
          Nome
        %td
          = @cegonha.motorista.nome 
      %tr
        %th 
          RG
        %td
          = @cegonha.motorista.rg
      %tr
        %th 
          CPF
        %td
          = @cegonha.motorista.cpf
      %tr
        %th 
          Telefone
        %td
          = @cegonha.motorista.telefone
      %tr
        %th 
          Celular
        %td
          = @cegonha.motorista.celular
      %tr
        %th 
          E-Mail
        %td
          = @cegonha.motorista.email
      %tr
        %th
          Observação
        %td
          = @cegonha.motorista.observacao

  - if @cegonha.empresa
    %div{:class => @grid}
      %table.text-left{ :cellspacing => "0", :summary => "Detalhes do Frete da Empresa", :width => '450px', 'data-equalizer-watch' => '' }
        %caption
          %h5
            Detalhes do Frete da Empresa Contratada
        %tr
          %th
            Valor do Frete
          %td
            = number_to_currency(@cegonha.debito.valor_frete)
        %tr
          %th 
            Taxa de Redespacho
          %td
            = number_to_currency(@cegonha.debito.taxa_despacho)
        %tr
          %th 
            Taxa de Plataforma
          %td
            = number_to_currency(@cegonha.debito.taxa_plataforma)
        %tr
          %th 
            Desconto
          %td
            = number_to_currency(@cegonha.debito.desconto)
        %tr
          %th 
            Valor Pago
          %td
            = number_to_currency(@cegonha.debito.valor_pago)
        %tr
          %th 
            Valor Total
          %td
            = number_to_currency(@cegonha.debito.valor_total)
        %tr
          %th 
            Saldo Devedor
          %td
            = number_to_currency(@cegonha.debito.saldo_devedor)
        %tr
          %th 
            Forma de Pagamento
          %td
            = @cegonha.debito.forma_pagamento
        %tr
          %th
            Observação
          %td
            = @cegonha.debito.observacao

  .row
    .large-12
      %ul
        - @versions.each do |version|
          %li
            = l(version.created_at, format: "%-d.%m.%Y %H:%M:%S %Z") 
          %li
            = version.changeset

- @cegonha.rotas.downto(1) do |i|
  - carros_na_rota = @cegonha.historicos.select{|hist| hist.rota == i}
  - frete_total = 0
  - saldo_devedor = 0
  - carros_na_rota.each do |hist|
    - frete_total = hist.car.debito.valor_total + frete_total unless hist.car.nil?
    - saldo_devedor =  hist.car.debito.saldo_devedor + saldo_devedor unless hist.car.nil?

  .row
    .large-12.end
      %table.text-left{ :cellspacing => "0", :summary => "Histórico da Cegonha", :width => '100%' } 
        - if i == @cegonha.rotas
          %caption.text-left
            %h5= "Rota Atual #{@cegonha.route_name}"
          %caption.text-left
            %p= "Frete Total: #{number_to_currency(frete_total)} | Saldo Devedor: #{number_to_currency(saldo_devedor)}"
        - else
          - h_nome = Historico.find_all_by_rota(i)
          - nome_rota = ""
          - if !h_nome.empty?
            - nome_rota = h_nome.first.nome_rota
          %caption
            %h5
              = "Rota #{i} #{nome_rota}"
          %caption
            %p
              = "Frete Total: #{number_to_currency(frete_total)} | Saldo Devedor: #{number_to_currency(saldo_devedor)}"

          - if carros_na_rota.empty?
            %th
              Nenhum carro na cegonha
          - else
            %tr
              %th{ :width => '1'}
                Nº
              %th
                Placa
              %th 
                Data de Entrada
              %th 
                Cidade de Entrada
              %th 
                Data de Saída
              %th 
                Cidade de Saída
              - carros_na_rota.each_with_index do |historico, index|
                %tr
                  %td
                    = index + 1
                  %td
                    = link_to(historico.car.placa, historico.car) unless historico.car.nil? 
                  %td
                    = historico.data_entrada.strftime("%d/%m/%Y") unless historico.data_entrada.nil? 
                  %td
                    = historico.localizacao_entrada 
                  %td
                    = historico.data_saida.strftime("%d/%m/%Y") unless historico.data_saida.nil? 
                  %td
                    = historico.localizacao_saida 

= link_to 'Editar', edit_cegonha_path(@cegonha), :class => :button
= link_to 'Voltar', cegonhas_path, :class => :button