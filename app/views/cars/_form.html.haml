-if @car.ativo != VEHICLE_STATUS.index('DELIVERED')
  -empresas = Empresa.all
  -compradores = Comprador.all 

  -if !current_user.admin?
    Desculpe, você precisa ter direitos administrativos para visualizar esta página!
  -else
    -if @editar_localizacao
      -render 'editar_localizacao'
    -else
      =form_for(@car) do |f|
        -if @car.errors.any?
          #error_explanation
            %h1
              =pluralize(@car.errors.count, "erro") 
              impediram que o cliente fosse atualizado:
            %ul
              -@car.errors.full_messages.each do |msg|
                %li
                  = msg

        -if @car.empresa
          <!-- Dados da empresa -->
          %fieldset
            %legend
              %h5{ :style => "font-size: 1.3em" }
                Dados da Empresa
            =f.fields_for :empresa do |builder|
              .floating_form
                .field
                  =builder.label :cnpj, "CNPJ*"
                  =builder.text_field :cnpj, :onkeyup =>"mascara(this,cnpj); fillFieldsEmpresa(this)",:maxlength=>"18", :size => '30', :id => 'empresa_cnpj'
                .field
                  = builder.label :nome, "Nome da Empresa*"
                  = builder.text_field :nome, :id => 'empresa_nome'
                .field
                  = builder.label :contato, "Nome do Contato"
                  = builder.text_field :contato, :id => 'empresa_contato'
              .field
                =builder.label :email, "E-Mail"
                =builder.text_field :email, :id => 'empresa_email'
              .field
                =builder.label :telefone
                =builder.text_field :telefone, :onkeyup => "mascara(this,telefone)", :maxlength => "14", :size => '30', :id => 'empresa_telefone'
              .field
                =builder.label :celular
                =builder.text_field :celular, :onkeyup =>"mascara(this,telefone)", :maxlength=>"15", :size => '30' , :id => 'empresa_celular'
              .field
                =builder.label :observacao, "Observação"
                =builder.text_area :observacao, :cols => 40, :rows => 7, :id => 'empresa_observacao'

        -elsif @car.comprador
          %br
          <!-- Dados do cliente-->
          %fieldset
            %legend
              %h5{ :style => "font-size: 1.3em"}
                Dados do Cliente
            = f.fields_for :comprador do |builder|
              %br
              .floating_form
                .field
                  =builder.label :cpf, "Digite o CPF cliente*"
                  =builder.text_field :cpf, :onkeyup =>"mascara(this,cpf); fillFieldsComprador(this)",:maxlength=>"14", :size => '30' , :id => 'comprador_cpf'
                .field
                  =builder.label :nome, "Nome Completo*"
                  =builder.text_field :nome, :id => 'comprador_nome'
                .field
                  =builder.label :email, "E-Mail"
                  =builder.text_field :email, :id => 'comprador_email'
                .field
                  =builder.label :rg, "RG"
                  =builder.text_field :rg , :id => 'comprador_rg'
                
              .field
                =builder.label :telefone
                =builder.text_field :telefone, :onkeyup => "mascara(this,telefone)", :maxlength => "14", :size => '30' , :id => 'comprador_telefone'
              .field
                =builder.label :celular
                =builder.text_field :celular, :onkeyup =>"mascara(this,telefone)", :maxlength=>"15", :size => '30' , :id => 'comprador_celular'
              .field
                =builder.label :parente, "Parente ou Conhecido do Cliente"
                =builder.text_field :parente, :id => 'comprador_parente'
              .field
                =builder.label :telefone_parente, "Telefone do Parente ou Conhecido do Cliente"
                =builder.text_field :telefone_parente, :onkeyup =>"mascara(this,telefone)", :maxlength=>"15", :size => '30' , :id => 'comprador_telefone_parente'
              .field
                =builder.label :observacao, "Observação"
                =builder.text_area "observacao".gsub("<br>", "\r\n"), :cols => 40, :rows => 7, :id => 'comprador_observacao'
              
        <!-- fim dos dados do comprador -->

        <!-- dados do veículo -->
        %fieldset
          %legend
            %h5{ :style => "font-size: 1.3em" }
              Dados do Veículo
          .floating_form
            .field
              = f.label :placa
              = f.text_field :placa, :onkeyup => "mascara(this, placa)", :maxlength => '8', :size => '15'
            .field
              = f.label "Modelo* (Por exemplo: Ford Ka)"
              = f.text_field :modelo 
            .field
              = f.label :data_compra, "Início da Prestação de Serviços"
              = f.date_select :data_compra, :order => [:day, :month, :year], :start_year => Time.now.year - 1 
            .field
              = f.label :data_prevista, "Data Prevista de Entrega"
              = f.date_select :data_prevista, :order => [:day, :month, :year], :start_year => Time.now.year, :include_blank => true 
          .field
            = f.label :status_pagamento_id, "Status do Pagamento"
            = f.select :status_pagamento_id,  StatusPagamento.all.collect {|p| [ p.status, p.id ] } 
          
          -@cegonhas.nil? ? @cegonhas = Cegonha.all : nil
          
          .field
            = f.label :cegonha_id, "Cegonha"
            = f.select :cegonha_id, @cegonhas.collect {|p| [ p.placa, p.id ] }, { :include_blank => true }, :onchange => "parceiroOrCegonhaNotBoth(this,'parceiro');", :id => 'cegonha'
          
          -@parceiros.nil? ? @parceiros = Parceiro.all : nil
          
          .field
            = f.label :parceiro_id, "Parceiro"
            = f.select :parceiro_id, @parceiros.collect {|p| [ p.nome, p.id ] }, { :include_blank => true}, :onchange => "parceiroOrCegonhaNotBoth(this,'cegonha');", :id => :parceiro  
          .field
            = f.label :ativo, "Status do Carro"
            = select_tag :ativo, options_for_select(vehicle_status_as_array_with_index, @car.ativo)
          .field
            = f.label :observacao, "Observação"
            = f.text_area :observacao, :cols => 40, :rows => 7
      
        <!-- dados do debito -->
        %fieldset
          %legend
            %h5{ :style => "font-size: 1.3em" }
              Dados do Frete
          = f.fields_for :debito do |builder|
            .floating_form
              .field
                =builder.label :valor_frete, "Valor do Frete"
                =builder.text_field :valor_frete, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.valor_frete, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
              .field
                =builder.label :taxa_plataforma, "Taxa de Plataforma"
                =builder.text_field :taxa_plataforma, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_plataforma, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
              .field
                =builder.label :taxa_plataforma_origem, "Taxa de Plataforma Origem"
                =builder.text_field :taxa_plataforma_origem, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_plataforma_origem, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
              .field
                =builder.label :taxa_plataforma_destino, "Taxa de Plataforma Destino"
                = builder.text_field :taxa_plataforma_destino, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_plataforma_destino, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')

            .field
              =builder.label :taxa_balsa, "Taxa de Balsa"
              =builder.text_field :taxa_balsa, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_balsa, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
            .field
              =builder.label :taxa_despacho, "Taxa de Redespacho"
              =builder.text_field :taxa_despacho, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_despacho, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
            .field
              =builder.label :desconto, "Desconto"
              =builder.text_field :desconto, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.desconto, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
            .field
              =builder.label :observacao, "Observação"
              =builder.text_area :observacao, :cols => 40, :rows => 7

        %fieldset
          %legend
            %h5{ :style => "font-size: 1.3em" }
              Dados dos Pagamentos
          = f.fields_for :pagamentos, @car.pagamentos.build do |builder|
            .field
              -if @car.comprador
                Total Pago pelo Cliente: 
                %b
                  = number_to_currency(soma_dos_pagamentos_efetuados(@car.comprador))
              -elsif @car.empresa
                Total Pago pela Empresa: 
                %b
                  = number_to_currency(soma_dos_pagamentos_efetuados(@car.empresa))

            .field
              -if @car.comprador
                Dívida Restante do Cliente: 
                %b
                  %span.red
                    = number_to_currency(saldo_devedor_do_cliente(@car.comprador))
                -elsif @car.empresa
                  Dívida Restante da Empresa: 
                  %b
                    %span.red
                      = number_to_currency(saldo_devedor_do_cliente(@car.empresa))

            .field
              =builder.label :forma_pagamento, "Forma do Novo Pagamento"
              =builder.text_field :forma_pagamento
            .field
              =builder.label :valor, "Valor do Novo Pagamento"
              =builder.text_field :valor, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  ""
            .field
              =builder.label :data_pagamento, "Data do Pagamento"
              =builder.date_select :data_pagamento, :order => [:day, :month, :year], :start_year => Time.now.year - 1 
        %br
        .actions
          -if @car.id.nil?
            = f.submit "Salvar e Editar Localização", :name => 'editar_localizacao', :car => @car
          -else
            = f.submit "Salvar"
            = f.submit "Salvar e Editar Localização", :name => 'editar_localizacao', :car => @car

-else
  = form_for(@car, :url => {:id => @car.id, :action => "limited_edit"},:method => :put) do |f|
    %fieldset
      %legend
        %h5{ :style => "font-size: 1.3em" }
          Dados do Frete
      <!-- dados do débito -->
      .field
        = f.label :status_pagamento_id
        = f.select :status_pagamento_id,  StatusPagamento.all.collect {|p| [ p.status, p.id ] }
      = f.fields_for :debito do |builder|
        .field
          =builder.label :forma_pagamento, "Forma de Pagamento"
          =builder.text_field :forma_pagamento
        .field
          =builder.label :valor_frete, "Valor do Frete"
          =builder.text_field :valor_frete, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.valor_frete, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
        .field
          =builder.label :taxa_plataforma, "Taxa de Plataforma"
          =builder.text_field :taxa_plataforma, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_plataforma, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
        .field
          =builder.label :taxa_despacho, "Taxa de Redespacho"
          =builder.text_field :taxa_despacho, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.taxa_despacho, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
        .field
          =builder.label :desconto, "Desconto"
          =builder.text_field :desconto, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.desconto, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
        .field
          =builder.label :valor_pago, "Valor Pago pelo Cliente"
          =builder.text_field :valor_pago, :onkeyup =>"moeda(this)", :style => "text-align: Right", :value =>  number_to_currency(@car.debito.valor_pago, :format => "%u %n", :separator => ",", :delimiter => ".", :unit => '')
        .field
          =builder.label :observacao, "Observação"
          =builder.text_area :observacao, :cols => 40, :rows => 7
    = f.submit "Salvar"
